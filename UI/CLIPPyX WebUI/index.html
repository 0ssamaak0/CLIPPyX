<!DOCTYPE html>
<html lang="en">

<head>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://raw.githubusercontent.com/0ssamaak0/CLIPPyX/main/assets/icon.png">
    <title>CLIPPyX WebUI</title>
    <link rel="stylesheet" href="CLIPPyX WebUI/styles.css">
</head>

<body>
    
    <div class="container">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Enter text to search">
            <select id="route-select" class="modern-select" onchange="changePlaceholder()">
                <option value="clip_text">Caption search</option>
                <option value="ebmed_text">Text content search</option>
                <option value="clip_image">Similar images search</option>
            </select>
            <button onclick="performSearch()" style="margin: 0 10px;">Search</button>
        </div>
        <div class="browser">
            <div class="results" id="results"></div>
            <div class="enlarged-img" id="enlarged-img-container"></div>
        </div>
        <div class="loader" id="loader"></div>   
    </div>
    
    <footer style="margin-top: 20px; text-align: center;">
        <p> 
            <a href="https://github.com/0ssamaak0/CLIPPyX">
                
                <img src="https://raw.githubusercontent.com/0ssamaak0/CLIPPyX/main/assets/logo_text.png" alt="CLIPPyX Logo"
                        style="height: 30px;">
                <i class="fab fa-github"></i> 
            </a>
        </p>
    </footer>

    <script>
        function changePlaceholder() {
            var select = document.getElementById('route-select');
            var input = document.getElementById('search-input');

            if (select.value == 'clip_text') {
                input.placeholder = 'Enter image caption or description';
            } else if (select.value == 'clip_image') {
                input.placeholder = 'Enter image full path';
            } else if (select.value == 'ebmed_text') {
                input.placeholder = 'Enter text to search for images with similar text';
            }
        }

        function performSearch() {
            const loader = document.getElementById('loader');
            const resultsDiv = document.getElementById('results');
            const enlargedImgContainer = document.getElementById('enlarged-img-container');

            loader.style.display = 'block';
            resultsDiv.innerHTML = '';
            enlargedImgContainer.innerHTML = '';
            loadImages()
        }

        function loadImages(){
            const query = document.getElementById('search-input').value;
            const route = document.getElementById('route-select').value;
            const port = window.location.port || 8080;  // Default to 8080 if no port is specified
            const url = `http://${window.location.hostname}:${port}/${route}`;
            const resultsDiv = document.getElementById('results');
            const count=20;
            topK=count+resultsDiv.childElementCount

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query, threshold: 0, top_k: topK })
            })
                .then(response => response.json())
                .then(data => {
                    loader.style.display = 'none';
                    data.forEach(path => {
                        const id= `http://${window.location.hostname}:${port}/images/${encodeURIComponent(path)}`
                        if (! document.getElementById(id)) {
                            const img = document.createElement('img');
                            img.id=id
                            img.src = img.id;
                            img.onclick = () => {
                                displayEnlargedImage(img.src);
                                highlightSelectedImage(img);
                            };
                            resultsDiv.appendChild(img);
                            console.log(""+resultsDiv.childElementCount+" Images");
                        }
                    });
                })
                .catch(error => {
                    loader.style.display = 'none';
                    console.error('Error:', error);
                });
        }

        function displayEnlargedImage(src) {
            const enlargedImgContainer = document.getElementById('enlarged-img-container');
            enlargedImgContainer.innerHTML = '';
            const img = document.createElement('img');
            img.src = src;
            img.onclick = () => {
                window.open(src);
            };
            enlargedImgContainer.appendChild(img);
        }

        function highlightSelectedImage(selectedImg) {
            const allImages = document.querySelectorAll('.results img');
            allImages.forEach(img => {
                img.classList.remove('selected-img');
            });
            selectedImg.classList.add('selected-img');
        }

        document.getElementById('results').addEventListener('scroll',()=>{
            const element=document.getElementById('results')
            // load new images if scrolled to 75%
            if(element.scrollTop+element.clientHeight > 0.75*element.scrollHeight){
                loadImages()
            }
        })

        // Add event listener for Enter key
        document.getElementById('search-input').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        });

    </script>
</body>

</html>